<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>HENKATEN BOARD</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<!-- LIBRARY PENYIMPANAN DATABASE LOKAL (IndexedDB) -->
<script src="https://cdn.jsdelivr.net/npm/idb-keyval@6/dist/umd.js"></script>

<!-- LIBRARY EXCEL (SheetJS) -->
<script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

<style>
/* =========================================
   1. CSS DASAR & RESET
   ========================================= */
* { box-sizing: border-box; }
body { margin: 0; font-family: Arial, Helvetica, sans-serif; background: #f5f5f5; overflow-x: hidden; }
.watermark { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); opacity: 0.12; pointer-events: none; z-index: 0; }
.watermark img { width: 560px; }
.content { position: relative; z-index: 1; display: flex; flex-direction: column; height: 100vh; }

/* =========================================
   2. HEADER (Compact - Height 60px)
   ========================================= */
.header {
    flex-shrink: 0; display: flex; align-items: center; justify-content: space-between; background: #06563d; color: #ffffff; padding: 0 20px; height: 60px; 
}
.header-left { display: flex; align-items: center; gap: 15px; }
.header-left input, .header-right select { 
    padding: 6px 10px; border-radius: 4px; border: none; font-weight: bold; font-size: 14px; cursor: pointer; color: #333; background: white;
}
#factorySelect { min-width: 150px; }
#realtimeClock { font-size: 18px; font-weight: bold; letter-spacing: 1px; color: #fff; border-left: 2px solid #ffffff50; padding-left: 15px; }
.btn-header-action {
    padding: 6px 15px; border-radius: 4px; border: none; background: white; color: #333; font-size: 14px; cursor: pointer; font-weight: bold; transition: 0.2s; white-space: nowrap; 
}
.btn-header-action:hover { background: #e0e0e0; color: #000; }
.header-center { font-size: 27px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; }
.header-right { display: flex; gap: 10px; align-items: center; }

/* =========================================
   3. MAIN LAYOUT
   ========================================= */
.main-layout { flex-grow: 1; display: grid; grid-template-columns: 360px 1fr; gap: 14px; padding: 14px; overflow: hidden; }
.left-col { display: flex; flex-direction: column; gap: 10px; height: 100%; overflow-y: auto; padding-right: 5px; }
.right-col { display: flex; flex-direction: column; gap: 10px; height: 100%; overflow: hidden; }
.right-scroll-area { flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; padding-right: 5px; }
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: #f1f1f1; }
::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: #999; }

/* =========================================
   4. COMPONENT BOXES
   ========================================= */
.box { background: #e8f5e9; border: 1px solid #c8e6c9; padding: 12px; border-radius: 8px; box-shadow: 0 1px 5px rgba(0,0,0,0.1); }
.box h3, .box h4 { margin-top: 0; margin-bottom: 8px; font-size: 15px; color: #333; }
.org-preview { width: 100%; min-height: 140px; background: #fff; border: 2px dashed #ccc; border-radius: 6px; display: flex; align-items: center; justify-content: center; cursor: pointer; overflow: hidden; }
.org-preview img { width: 100%; max-height: 200px; object-fit: contain; }

.absensi-flex { display: flex; flex-direction: column; gap: 5px; align-items: center; }
.chart-wrapper { position: relative; width: 150px; height: 150px; }
.chart-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; }
#centerValue { font-size: 20px; font-weight: bold; }
.absen-bar { margin-top: 10px; background: #fff; border: 1px solid #ccc; border-radius: 12px; overflow: hidden; width: 100%; }
.absen-fill { background: #2ecc71; color: white; text-align: center; font-weight: bold; padding: 3px; width: 0%; font-size: 11px; white-space: nowrap; }

.legend { font-size: 10px; width: 100%; display: grid; grid-template-columns: 1fr 1fr; gap: 4px; margin-top: 8px; }
.legend-item { display: flex; align-items: center; gap: 5px; }
.dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
.green{background:#2ecc71}.red{background:#e74c3c}.blue-dark{background:#1f3c88}.blue-light{background:#5dade2}.orange{background:#f39c12}.pink{background:#ff69b4}.purple{background:#8e44ad}.yellow{background:#f1c40f}

.input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }
input, select, button { width: 100%; padding: 5px; margin: 2px 0; box-sizing: border-box; font-size: 12px; background: white; border: 1px solid #aaa; border-radius: 3px; }
button { background: #2ecc71; color: #fff; border: none; border-radius: 4px; cursor: pointer; padding: 8px; font-weight: bold; }

/* =========================================
   5. REPORT SUMMARY
   ========================================= */
.report-summary-box { flex-shrink: 0; }
.report-summary-box h3 { color: #333; border-bottom: none; padding-bottom: 0; }
.report-stats-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-bottom: 10px; margin-top: 10px; }
.report-stat-item { background: #fff; border: 1px solid #c8e6c9; border-radius: 6px; padding: 10px 4px; text-align: center; display: flex; flex-direction: column; justify-content: center; min-height: 85px; }
.report-stat-value { font-size: 28px; font-weight: bold; color: #006c2d; margin-bottom: 4px; line-height: 1; }
.report-stat-label { font-size: 11px; color: #555; text-transform: uppercase; font-weight: bold; line-height: 1.2; }
.report-btn-group { display: flex; gap: 8px; width: 50%; }
.report-btn { flex: 1; padding: 8px 12px; font-size: 13px; border-radius: 4px; border: none; cursor: pointer; color: white; font-weight: bold; white-space: nowrap; }
.btn-detail { background: #1f3c88; }
.btn-trend { background: #27ae60; } 

/* =========================================
   6. LOG SECTION
   ========================================= */
.log-box { flex-shrink: 0; margin-top: 5px; } 
.scrollBox { max-height: 180px; overflow-y: auto; border: 1px solid #aaa; margin-bottom: 10px; background: white; }
table.log-table { width: 100%; border-collapse: collapse; font-size: 11px; }
table.log-table th { background: #006c2d; color: white; position: sticky; top: 0; padding: 6px; text-align: left; z-index: 2; }
table.log-table td { border-bottom: 1px solid #eee; padding: 5px 6px; vertical-align: top; }
table.log-table tr:nth-child(even) { background: #f9f9f9; }
.btn-delete { background: #e74c3c; color: white; border: none; width: 20px; height: 20px; border-radius: 50%; cursor: pointer; font-size: 12px; padding: 0; display: inline-flex; align-items: center; justify-content: center; line-height: 1; }
.btn-delete:hover { background: #c0392b; }

/* =========================================
   7. MACHINE & GRID
   ========================================= */
#keyPersonsContainer, #machineContainer { width: 100%; display: flex; flex-direction: column; gap: 10px; }
.group-container { background: #fff3e0; border: 1px solid #ffb74d; border-radius: 8px; padding: 15px; margin-bottom: 0; margin-top: 15px; position: relative; }
.group-title { background: #006c2d; color: white; padding: 4px 15px; border-radius: 20px; font-weight: bold; font-size: 13px; position: absolute; top: -12px; left: 50%; transform: translateX(-50%); white-space: nowrap; z-index: 2; }
.machine-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(165px, 1fr)); gap: 10px; margin-top: 5px; }
.box.machine-box { background: white; border: 1px solid #ddd; position: relative; padding-top: 35px; padding-bottom: 10px; display: flex; flex-direction: column; justify-content: space-between; }
.box.machine-box h4 { font-weight: bold; text-align: center; font-size: 13px; margin: 0 0 8px 0; color: #000; text-transform: uppercase; height: 16px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
input[type="file"] { display: none !important; }
.status-lights-container { position: absolute; top: 8px; left: 8px; right: auto; display: flex; gap: 4px; z-index: 10; flex-wrap: wrap; justify-content: flex-start; max-width: 90%; }
.status-light { width: 14px; height: 14px; border-radius: 50%; border: 1px solid rgba(0,0,0,0.3); box-shadow: 1px 1px 3px rgba(0,0,0,0.3); flex-shrink: 0; }
.light-Man { background-color: #e74c3c; } .light-Material { background-color: #f1c40f; } .light-Machine { background-color: #3498db; } .light-Method { background-color: #2ecc71; }    
.preview { width: 100%; height: 85px; background: #eee; border: 1px dashed #bbb; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; overflow: hidden; margin-bottom: 12px; }
.preview img { width: 100%; height: 100%; object-fit: cover; }
.circle-wrapper { display: flex; flex-direction: row; justify-content: center; align-items: flex-start; gap: 8px; margin-top: 0px; overflow-x: hidden; }
.circle-wrapper.compact { gap: 2px; }
.circle-item { display: flex; flex-direction: column; align-items: center; width: 55px; flex-shrink: 0; }
.circle-item.compact { width: 45px; }
.circle { width: 50px; height: 50px; border-radius: 50%; background: #ddd; border: 1px dashed #999; cursor: pointer; overflow: hidden; display: flex; align-items: center; justify-content: center; margin-bottom: 3px; transition: all 0.2s; }
.circle.small { width: 38px; height: 38px; }
.circle img { width: 100%; height: 100%; object-fit: cover; }
.operator-name { font-size: 9px; color: #000; text-align: center; line-height: 1.1; font-weight: bold; word-wrap: break-word; width: 100%; min-height: 22px; }

/* =========================================
   8. MODALS
   ========================================= */
.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); display: none; justify-content: center; align-items: center; z-index: 1000; }
.modal-content { background: white; width: 90%; max-width: 900px; max-height: 90vh; border-radius: 8px; padding: 20px; position: relative; display: flex; flex-direction: column; }
.modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #006c2d; padding-bottom: 10px; margin-bottom: 10px; }
.modal-header h2 { margin: 0; font-size: 20px; color: #006c2d; }
.close-modal { background: #e74c3c; border: none; color: white; width: 30px; height: 30px; border-radius: 50%; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 0; margin-left: 10px; padding-bottom: 2px; line-height: 0; font-weight: bold; transition: 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
.close-modal:hover { background: #c0392b; transform: scale(1.1); }
.modal-body { overflow-y: auto; flex-grow: 1; }
.modal-table { width: 100%; border-collapse: collapse; font-size: 12px; }
.modal-table th { background: #006c2d; color: white; padding: 8px; position: sticky; top: 0; }
.modal-table td { border-bottom: 1px solid #ddd; padding: 8px; }

/* STYLE UNTUK REMINDER BOX */
.reminder-box { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; padding: 10px; margin-bottom: 10px; border-radius: 4px; font-size: 12px; line-height: 1.5; }

.btn-save-modal { background-color: #2ecc71; color: white; border: none; padding: 6px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; margin-right: 0; }
.btn-exit-modal { background-color: #e74c3c; color: white; border: none; padding: 6px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; margin-left: 10px; }
.btn-exit-modal:hover { background-color: #c0392b; }

/* STYLE TOMBOL EDIT & SAVE BARIS */
.btn-edit-row { background-color: #f39c12; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 11px; width: 100%; }
.btn-save-row { background-color: #2ecc71; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 11px; width: 100%; font-weight: bold; }

.modal-group-header { background-color: #eee; color: #333; font-weight: bold; font-size: 13px; padding: 8px !important; text-align: left; border-top: 2px solid #ccc; }
.btn-delete-row { background-color: #e74c3c; color: white; border: none; width: 22px; height: 22px; border-radius: 50%; cursor: pointer; font-weight: bold; display: inline-flex; align-items: center; justify-content: center; font-size: 14px; line-height: 1; }
.btn-delete-row:hover { background-color: #c0392b; }
.btn-add-section { background-color: #2ecc71; color: white; border: none; width: 22px; height: 22px; border-radius: 50%; cursor: pointer; font-weight: bold; display: inline-flex; align-items: center; justify-content: center; font-size: 15px; line-height: 1; }
.btn-add-section:hover { background-color: #27ae60; }
.input-edit { width: 100%; padding: 4px; border: 1px solid #aaa; border-radius: 3px; font-size: 11px; }

/* =========================================
   9. LARGE SCREENS
   ========================================= */
@media (min-width: 1600px) {
    .main-layout { grid-template-columns: 420px 1fr; gap: 20px; padding: 20px; }
    .header { height: 70px; padding: 0 30px; }
    .header-center { font-size: 36px; } 
    .box { padding: 20px; }
    .box h3 { font-size: 18px; }
    .machine-grid { grid-template-columns: repeat(auto-fill, minmax(190px, 1fr)); gap: 15px; }
    .box.machine-box h4 { font-size: 15px; margin-bottom: 10px; }
    .preview { height: 100px; margin-bottom: 18px; }
    .circle { width: 58px; height: 58px; }
    .circle.small { width: 46px; height: 46px; }
    .circle-item { width: 65px; }
    .circle-item.compact { width: 52px; }
    .operator-name { font-size: 11px; }
    table.log-table { font-size: 13px; }
    .scrollBox { max-height: 250px; }
    input, select, button { padding: 8px; font-size: 14px; }
    .status-light { width: 18px; height: 18px; } 
}
</style>
</head>

<body>

<div class="watermark"><img src="sugity.png"></div>

<div class="content">

<div class="header">
    <div class="header-left">
        <input type="date" id="tanggalHari" onchange="loadAllData()">
        <div id="realtimeClock">00:00:00</div>
    </div>
    <div class="header-center" id="displayTitle">HENKATEN BOARD</div>
    <div class="header-right">
        <select id="shiftSelect" onchange="loadAllData()">
            <option value="Shift A">Shift A</option>
            <option value="Shift B">Shift B</option>
        </select>
        <select id="factorySelect" onchange="loadAllData()">
            <option value="Factory 2">Factory 2</option>
            <option value="Factory 3 & 4">Factory 3 & 4</option>
        </select>
        <button class="btn-header-action" onclick="exportExcel()">ðŸ“¤ Export Excel</button>
    </div>
</div>

<div class="main-layout">
    <!-- KOLOM KIRI -->
    <div class="left-col">
        <div class="box">
            <h3>Organizational Structure</h3>
            <div class="org-preview" id="orgPreview" onclick="document.getElementById('inputOrg').click()"></div>
            <input type="file" accept="image/*" id="inputOrg" onchange="handleFile(this, 'orgPreview')">
        </div>

        <div class="box absensi-wrapper">
            <h3>Attendance Chart</h3>
            <div class="absensi-flex">
                <div class="chart-wrapper">
                    <canvas id="myChart"></canvas>
                    <div class="chart-center">
                        <div id="centerValue">0 / 0</div>
                        <div style="font-size:12px">MP</div>
                    </div>
                </div>
                <div class="legend">
                    <div class="legend-item"><span class="dot green"></span>Hadir</div>
                    <div class="legend-item"><span class="dot red"></span>Belum Absen</div>
                    <div class="legend-item"><span class="dot blue-dark"></span>Pengawas Cuti</div>
                    <div class="legend-item"><span class="dot blue-light"></span>Pengawas Sakit</div>
                    <div class="legend-item"><span class="dot orange"></span>Pengawas Izin</div>
                    <div class="legend-item"><span class="dot pink"></span>Operator Cuti</div>
                    <div class="legend-item"><span class="dot purple"></span>Operator Sakit</div>
                    <div class="legend-item"><span class="dot yellow"></span>Operator Izin</div>
                </div>
            </div>
            <div class="absen-bar">
                <div class="absen-fill" id="rasioText">Attendance: 0%</div>
            </div>
        </div>

        <div class="box">
            <h3>Attendance Input</h3>
            <!-- Di sini bagian input diedit agar tidak otomatis refresh -->
            <div class="input-grid">
                <input type="number" id="mpHadir" placeholder="MP Hadir">
                <input type="number" id="mpBelum" placeholder="MP Belum Absen">
                <input type="number" id="pCuti" placeholder="Pengawas Cuti">
                <input type="number" id="pSakit" placeholder="Pengawas Sakit">
                <input type="number" id="pIjin" placeholder="Pengawas Izin">
                <input type="number" id="oCuti" placeholder="Operator Cuti">
                <input type="number" id="oSakit" placeholder="Operator Sakit">
                <input type="number" id="oIjin" placeholder="Operator Izin">
            </div>
            <!-- Tombol diganti menjadi Save Attendance -->
            <button style="margin-top:10px" onclick="saveAttendanceData()">Save Attendance</button>
        </div>

        <div class="box">
            <h3>Factory Updates</h3>
            <button onclick="showEmployeeModal()">Update Factory</button>
        </div>
    </div>

    <!-- KOLOM KANAN -->
    <div class="right-col">
        <div class="box report-summary-box">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <h3 style="margin: 0;">Report Summary & Analytics</h3>
                <div class="report-btn-group">
                    <button class="report-btn btn-detail" onclick="showDetailedReport()">ðŸ“Š Detailed Report</button>
                    <button class="report-btn btn-trend" onclick="showProblemTrend()">ðŸ“ˆ Problem Trend</button>
                </div>
            </div>
            <div class="report-stats-grid">
                <div class="report-stat-item"><div class="report-stat-value" id="totalMachines">0</div><div class="report-stat-label">Total Machines</div></div>
                <div class="report-stat-item"><div class="report-stat-value" id="normalMachines">0</div><div class="report-stat-label">Normal Status</div></div>
                <div class="report-stat-item"><div class="report-stat-value" id="problemMachines">0</div><div class="report-stat-label">Problem Status</div></div>
                <div class="report-stat-item"><div class="report-stat-value" id="manProblems">0</div><div class="report-stat-label">Man Problems</div></div>
                <div class="report-stat-item"><div class="report-stat-value" id="materialProblems">0</div><div class="report-stat-label">Material Problems</div></div>
                <div class="report-stat-item"><div class="report-stat-value" id="machineProblems">0</div><div class="report-stat-label">Machine Problems</div></div>
                <div class="report-stat-item"><div class="report-stat-value" id="methodProblems">0</div><div class="report-stat-label">Method Problems</div></div>
            </div>
        </div>

        <div class="right-scroll-area">
            <div id="keyPersonsContainer"></div>
            <div id="machineContainer"></div>
            <div class="box log-box" id="logSection">
                <h3>Employee Changes Log</h3>
                <div class="scrollBox" id="logScrollContainer">
                    <table class="log-table">
                        <thead>
                            <tr>
                                <th>Date</th><th>Problem Types</th><th>Location</th><th>Problem Description</th><th>Cause</th><th>Countermeasure</th><th>PIC</th><th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="logTableBody"></tbody>
                    </table>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:5px;">
                    <select id="logJenis"><option value="">-- Problem Type --</option><option>Man</option><option>Material</option><option>Machine</option><option>Method</option></select>
                    <select id="logLokasi"><option value="">-- Location --</option></select>
                    <input type="text" id="logPIC" placeholder="PIC">
                    <input type="text" id="logCause" placeholder="Cause">
                    <input type="text" id="logCounter" placeholder="Countermeasure">
                    <input type="text" id="logDeskripsi" placeholder="Problem Description">
                    <button style="grid-column: span 3;" onclick="tambahLog()">Add Log</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODAL DETAILED REPORT -->
<div class="modal-overlay" id="reportModal" onclick="if(event.target === this) closeModal()">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Detailed Report & Analytics</h2>
            <button class="close-modal" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <table class="modal-table">
                <thead><tr><th>Date</th><th>Shift</th><th>Factory</th><th>Machine</th><th>Status</th><th>Problem Type</th><th>Description</th><th>PIC</th></tr></thead>
                <tbody id="reportTableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- MODAL PROBLEM TREND -->
<div class="modal-overlay" id="trendModal" onclick="if(event.target === this) closeTrendModal()">
    <div class="modal-content" style="max-width: 1000px;">
        <div class="modal-header">
            <h2 id="trendTitle">ðŸ“ˆ Problem Trend Analysis</h2>
            <button class="close-modal" onclick="closeTrendModal()">Ã—</button>
        </div>
        <div class="modal-body"><div style="height: 450px; width: 100%;"><canvas id="trendChart"></canvas></div></div>
    </div>
</div>

<!-- MODAL FACTORY UPDATES -->
<div class="modal-overlay" id="employeeModal" onclick="if(event.target === this) closeEmployeeModal()">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Factory Updates</h2>
            <div style="display:flex; align-items:center;">
                <button class="btn-save-modal" onclick="saveEmployeeChanges()">Save</button>
                <button class="btn-exit-modal" onclick="closeEmployeeModal()">Exit</button>
            </div>
        </div>
        <div class="modal-body">
            <!-- REMINDER BOX ADDED HERE -->
            <div class="reminder-box">
                <strong>Reminder !</strong><br>
                <strong>Please list multiple operators' names separated by commas (e.g., "Budi, Ani, Ahmad").</strong><br>
                <i>This ensures each name is correctly aligned with its corresponding photo.</i>
            </div>

            <table class="modal-table">
                <thead>
                    <tr>
                        <th style="width: 25%">Location</th>
                        <th style="width: 15%; text-align:center">Total MP</th>
                        <th style="width: 40%">Employee Name</th>
                        <th style="width: 10%; text-align:center">Edit</th>
                        <th style="width: 10%; text-align:center">Action</th>
                    </tr>
                </thead>
                <tbody id="employeeTableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
// ==========================================================
// 1. SCRIPT JAM REAL TIME
// ==========================================================
function updateClock() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false }).replace(/\./g, ':');
    document.getElementById('realtimeClock').innerText = timeString;
}
setInterval(updateClock, 1000); 
updateClock(); 

// ==========================================================
// 2. KONFIGURASI DEFAULT (DATA AWAL)
// ==========================================================
const defaultFactoryConfig = {
    "Factory 2": [
        { title: "Key Persons", machines: ["KY Resin", "KY Assy (1)", "KY Assy (2)", "TL Resin", "TL Assy (1)", "TL Assy (2)", "GL"] },
        { title: "Resin Injection", machines: ["#01-2500T", "#02-3500T", "#03-3500T", "#04-2500T", "#05-3500T","#06-2500T", "#07-2500T", "#08-2500T", "Crane 30T", "Trans. Matl", "Trans. Part"] },
        { title: "SA Qtr & Door Trim", machines: ["Robot 1", "Robot 2", "Robot 3", "Robot 4", "Robot 5", "Final Check", "SPS", "Setting FG", "Repair Part"] },
        { title: "SA Doortrim D26A", machines: ["Pos 1", "Pos 2", "Pos 3", "Quality", "Repair Part (Area bawah)", "Setting Fax", "Trans. Child Part"] }
    ],
    "Factory 3 & 4": [
        { title: "Resin Injection (F3)", machines: ["#01-1300T", "#02-1300T", "#03-1300T", "#04-1050T", "#05-2500T", "#06-1600T", "#07-2500T", "#08-2500T", "#09-1600T", "#10-1600T", "#10a-650T", "#13-650T", "#14-650T", "MC Vibration", "Crane 18T", "Crane 7.5T", "Trans. Matl", "Trans. Part"] },
        { title: "Resin Injection (F4)", machines: ["#01-350T", "#08-350T", "Crane 18T (F4)", "Assy 1", "Assy 2", "Assy 3", "Crushing"] }
    ]
};

const defaultOperatorMapping = {
    "Factory 2": {
        "#01-2500T": { "Shift A": ["Bagus T.", "Didin P.", "Wahyu U."], "Shift B": ["Andri S.", "Zuliyatno", "Yaman"] },
        "#02-3500T": { "Shift A": ["Fariq N", "Sulthan"], "Shift B": ["Rakha A.", "Alfan"] },
        "#03-3500T": { "Shift A": ["Nugroho"], "Shift B": ["Avian A."] },
        "#04-2500T": { "Shift A": ["M. Daffa"], "Shift B": ["Ricky Z."] },
        "#05-3500T": { "Shift A": ["M. Rizki"], "Shift B": ["Sheva R."] },
        "#06-2500T": { "Shift A": ["M. Irsan", "Candra W."], "Shift B": ["Raldyas", "Chardon S."] },
        "#07-2500T": { "Shift A": ["Fahry A."], "Shift B": ["M. Shofwan"] },
        "#08-2500T": { "Shift A": ["Niko F."], "Shift B": ["Rahmat H."] },
        "Crane 30T": { "Shift A": ["Ketut B.", "Rico J."], "Shift B": ["Sahrulloh", "Slamet R."] },
        "Trans. Part": { "Shift A": ["Wahyu M", "Ujang K"], "Shift B": ["Leonard", "Rahmat H."] },
        "Trans. Matl": { "Shift A": ["Saptadi", "Robby"], "Shift B": ["Untara I.", "Adit Tria"] },
        "Robot 1": { "Shift A": ["Pilatus R.", "Ali N."], "Shift B": ["Irham M.", "Febriana"] },
        "Robot 2": { "Shift A": ["Maisal N.", "Gunawan W."], "Shift B": ["M. Al Ghifari", "Chairil A."] },
        "Robot 3": { "Shift A": ["Warsito"], "Shift B": ["Wahyu P."] },
        "Robot 4": { "Shift A": ["Saprigon", "Ego Wirya"], "Shift B": ["Dedi S.", "Toto S."] },
        "Robot 5": { "Shift A": ["Yosep A.", "Ahmad Rifki"], "Shift B": ["Doharles", "Chairul F."] },
        "Quality": { "Shift A": ["Andjar T."], "Shift B": ["Akbar S."] },
        "SPS": { "Shift A": ["M. Wahyudin", "Hery S."], "Shift B": ["Rizal A.", "Yulih"] },
        "Setting FG": { "Shift A": ["Sukma W.", "Aman B."], "Shift B": ["Yugo K."] },
        "Repair Part": { "Shift A": ["Dede J."], "Shift B": ["Fakhih A."] },
        "Pos 1": { "Shift A": ["Fadil M."], "Shift B": ["Rafli N."] },
        "Pos 2": { "Shift A": ["Oloan Munthe"], "Shift B": ["Mardi"] },
        "Pos 3": { "Shift A": ["Tajul A."], "Shift B": ["Dzulfi R."] },
        "Final Check": { "Shift A": ["Siska S.", "Pandu P."], "Shift B": ["Sindi N.", "Arya N."] },
        "Setting Fax": { "Shift A": ["Junedi S."], "Shift B": ["Adib A."] },
        "Repair Part (Area bawah)": { "Shift A": ["Barhalen"], "Shift B": ["Achmad F."] },
        "Trans. Child Part": { "Shift A": ["Eko R."], "Shift B": ["Ardial F."] },
        "KY Resin": { "Shift A": ["A. Latif"], "Shift B": ["Gunawan"] },
        "KY Assy (1)": { "Shift A": ["Bambang B."], "Shift B": ["Dwinanto"] },
        "KY Assy (2)": { "Shift A": ["M. Fadli"], "Shift B": ["Arif W."] },
        "TL Resin": { "Shift A": ["Enu Y."], "Shift B": ["Suprayogi"] },
        "TL Assy (1)": { "Shift A": ["Endang S."], "Shift B": ["Heri Jumanto"] },
        "TL Assy (2)": { "Shift A": ["Jamson R."], "Shift B": ["Dede Saleh"] },
        "GL": { "Shift A": ["Heri Waluya"], "Shift B": ["Riki Suhendi"] }
    },
    "Factory 3 & 4": {}
};

const defaultCircleCounts = {}; // Menyimpan preferensi jumlah lingkaran jika beda dari default

// Variable Global untuk Config Aktif
let activeFactoryConfig = null;
let activeOperatorMapping = null;
let activeCircleCounts = null;

// ==========================================================
// 4. LOGIKA & FUNGSI UTAMA
// ==========================================================
function getCircleCount(factory, name) {
    // 1. Cek jika ada custom count di database
    if (activeCircleCounts && activeCircleCounts[factory] && activeCircleCounts[factory][name]) {
        return activeCircleCounts[factory][name];
    }

    // 2. Jika tidak ada, pakai logic default (hardcoded)
    if (factory !== "Factory 2") return 2; 
    const mapping = {
        "#01-2500T": 3, "#02-3500T": 2, "#06-2500T": 2, "Crane 30T": 2, 
        "Trans. Part": 2, "Trans. Matl": 2, "Robot 1": 2, "Robot 2": 2, 
        "Robot 4": 2, "Robot 5": 2, "SPS": 2, "Setting FG": 2, "Final Check": 2
    };
    return mapping[name] || 2; 
}

function getKey(elementId) {
    const date = document.getElementById("tanggalHari").value;
    const factory = document.getElementById("factorySelect").value;
    const shift = document.getElementById("shiftSelect").value;
    return `${date}_${factory}_${shift}_${elementId}`;
}

document.getElementById("tanggalHari").value = new Date().toISOString().split("T")[0];

// FUNGSI BARU UNTUK MENYIMPAN DATA ATTENDANCE SAAT TOMBOL DITEKAN
// ================================================================
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyhWL4p7zLm_ZJJmyhK4iORR8WKveUUTLK2DC0u7-mIYGEQ73FK9YehvdpVRr_N7BNu/exec"; 

async function saveAttendanceData() {
    // Ambil tombol untuk efek visual
    const btn = document.getElementById("btnSaveAttendance") || document.querySelector("button[onclick='saveAttendanceData()']");
    const originalText = btn ? btn.innerText : "Save Attendance";

    try {
        // 1. EFEK LOADING
        if(btn) {
            btn.innerText = "â³ Sending...";
            btn.disabled = true;
            btn.style.backgroundColor = "#7f8c8d"; // Warna abu-abu saat loading
        }

        // 2. SIMPAN KE DATABASE LOKAL (IndexedDB)
        // Agar data tidak hilang saat refresh browser
        const inputs = ["mpHadir","mpBelum","pCuti","pSakit","pIjin","oCuti","oSakit","oIjin"];
        for (const id of inputs) {
            const val = document.getElementById(id).value;
            await idbKeyval.set(getKey(id), val);
        }

        // 3. UPDATE DIAGRAM & LAPORAN (Agar animasi berputar smooth)
        if (typeof buatDiagram === "function") buatDiagram(); 
        if (typeof updateReportSummary === "function") updateReportSummary();

        // 4. PERSIAPAN DATA UNTUK DIKIRIM KE GOOGLE SHEET
        const dataKehadiran = {
            date: document.getElementById("tanggalHari").value,
            shift: document.getElementById("shiftSelect") ? document.getElementById("shiftSelect").value : "-",
            factory: document.getElementById("factorySelect") ? document.getElementById("factorySelect").value : "-",
            mpHadir: document.getElementById("mpHadir").value || 0,
            mpBelum: document.getElementById("mpBelum").value || 0,
            pCuti: document.getElementById("pCuti").value || 0,
            pSakit: document.getElementById("pSakit").value || 0,
            pIjin: document.getElementById("pIjin").value || 0,
            oCuti: document.getElementById("oCuti").value || 0,
            oSakit: document.getElementById("oSakit").value || 0,
            oIjin: document.getElementById("oIjin").value || 0
        };

        // 5. KIRIM DATA (FETCH)
        await fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors', // Penting untuk mengirim ke Google Apps Script tanpa error CORS di browser
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(dataKehadiran)
        });

        // 6. SUKSES (Tombol jadi Hijau)
        if(btn) {
            btn.innerText = "âœ… Saved & Sent!";
            btn.style.backgroundColor = "#27ae60"; 
        }

    } catch (error) {
        console.error("Gagal kirim:", error);
        // Jika gagal kirim (misal internet mati), beri info tersimpan lokal
        if(btn) {
            btn.innerText = "âš ï¸ Saved Locally";
            btn.style.backgroundColor = "#f39c12"; // Warna oranye
        }
    } finally {
        // KEMBALIKAN TOMBOL SETELAH 2 DETIK
        setTimeout(() => {
            if(btn) {
                btn.innerText = originalText;
                btn.style.backgroundColor = ""; // Reset warna ke CSS asli
                btn.disabled = false;
            }
        }, 2000);
    }
}

function handleInput(el) {
    idbKeyval.set(getKey(el.id), el.value).then(() => { updateReportSummary(); });
    // Dihapus agar tidak refresh otomatis chart:
    // if(el.id.includes("mp") || el.id.startsWith("p") || el.id.startsWith("o")) buatDiagram();
}

function handleFile(input, previewId) {
    const file = input.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        document.getElementById(previewId).innerHTML = `<img src="${e.target.result}">`;
        let storageKey;
        const factory = document.getElementById("factorySelect").value;
        const shift = document.getElementById("shiftSelect").value;
        if (input.id === 'inputOrg') { storageKey = `ORG_STRUCT_${factory}`; } 
        else if (input.id.startsWith('fileMachine-')) { storageKey = `MACHINE_BOX_${factory}_${input.id}`; } 
        else if (input.id.startsWith('fileCircle-')) { storageKey = `CIRCLE_${factory}_${shift}_${input.id}`; } 
        else { storageKey = getKey(input.id); }
        idbKeyval.set(storageKey, e.target.result);
    };
    reader.readAsDataURL(file);
}

function renderMachines() {
    const factory = document.getElementById("factorySelect").value;
    const shift = document.getElementById("shiftSelect").value; 
    const groups = activeFactoryConfig[factory] || [];
    
    const mainContainer = document.getElementById("machineContainer");
    const keyContainer = document.getElementById("keyPersonsContainer");
    mainContainer.innerHTML = "";
    keyContainer.innerHTML = "";

    let globalMachineIndex = 1;

    groups.forEach(group => {
        const groupDiv = document.createElement("div");
        groupDiv.className = "group-container";
        groupDiv.innerHTML = `<div class="group-title">${group.title}</div>`;
        const gridDiv = document.createElement("div");
        gridDiv.className = "machine-grid";

        const isKeyPersons = group.title === "Key Persons";

        group.machines.forEach(machineName => {
            const idx = globalMachineIndex++;
            const circlesNeeded = getCircleCount(factory, machineName);
            const useSmallCircles = circlesNeeded >= 3;
            const circleClass = useSmallCircles ? "circle small" : "circle";
            const itemClass = useSmallCircles ? "circle-item compact" : "circle-item";
            const wrapperClass = useSmallCircles ? "circle-wrapper compact" : "circle-wrapper";

            let circleHtml = "";
            let namesList = [];
            if (activeOperatorMapping[factory] && activeOperatorMapping[factory][machineName]) {
                namesList = activeOperatorMapping[factory][machineName][shift] || [];
            }

            for(let c=1; c<=circlesNeeded; c++) {
                const operatorName = namesList[c-1] ? namesList[c-1] : "";
                circleHtml += `
                    <div class="${itemClass}">
                        <div class="${circleClass}" id="circlePreview-${idx}-${c}" onclick="document.getElementById('fileCircle-${idx}-${c}').click()"></div>
                        <div class="operator-name">${operatorName}</div>
                    </div>
                    <input type="file" id="fileCircle-${idx}-${c}" accept="image/*" onchange="handleFile(this, 'circlePreview-${idx}-${c}')">
                `;
            }

            let machineImageHtml = "";
            if (!isKeyPersons) {
                machineImageHtml = `
                    <div class="preview" id="preview${idx}" onclick="document.getElementById('fileMachine-${idx}').click()"></div>
                    <input type="file" id="fileMachine-${idx}" accept="image/*" onchange="handleFile(this, 'preview${idx}')">
                `;
            }

            gridDiv.innerHTML += `
            <div class="box machine-box" id="machine-${idx}" data-name="${machineName}">
                <div class="status-lights-container" id="lights-${idx}"></div> 
                <h4 title="${machineName}">${machineName}</h4>
                ${machineImageHtml}
                <div class="${wrapperClass}">${circleHtml}</div>
            </div>`;
        });
        groupDiv.appendChild(gridDiv);
        if (isKeyPersons) keyContainer.appendChild(groupDiv);
        else mainContainer.appendChild(groupDiv);
    });
}

function populateLogLocations() {
    const select = document.getElementById("logLokasi");
    select.innerHTML = '<option value="">-- Location --</option>';
    const currentFactory = document.getElementById("factorySelect").value;
    (activeFactoryConfig[currentFactory] || []).forEach(group => {
        group.machines.forEach(machine => {
            const opt = document.createElement("option");
            opt.value = machine; opt.innerText = machine; select.appendChild(opt);
        });
    });
}

async function loadAllData() {
    // LOAD ACTIVE CONFIG
    activeFactoryConfig = await idbKeyval.get("FACTORY_CONFIG") || JSON.parse(JSON.stringify(defaultFactoryConfig));
    // LOAD ACTIVE OPERATOR MAPPING
    activeOperatorMapping = await idbKeyval.get("OPERATOR_MAPPING") || JSON.parse(JSON.stringify(defaultOperatorMapping));
    // LOAD ACTIVE CIRCLE COUNTS
    activeCircleCounts = await idbKeyval.get("CIRCLE_COUNTS") || JSON.parse(JSON.stringify(defaultCircleCounts));

    const factory = document.getElementById("factorySelect").value;
    const shift = document.getElementById("shiftSelect").value;
    
    document.getElementById("displayTitle").innerText = "HENKATEN BOARD - " + factory.toUpperCase();

    renderMachines();
    populateLogLocations();
    
    document.querySelectorAll(".input-grid input, #logPIC, #logDeskripsi, #logCause, #logCounter").forEach(el => el.value = "");
    document.getElementById("orgPreview").innerHTML = "";
    document.getElementById("logTableBody").innerHTML = "";
    
    const inputs = ["mpHadir","mpBelum","pCuti","pSakit","pIjin","oCuti","oSakit","oIjin"];
    for (const id of inputs) {
        const val = await idbKeyval.get(getKey(id));
        if (val) document.getElementById(id).value = val;
    }

    const orgKey = `ORG_STRUCT_${factory}`;
    const orgImg = await idbKeyval.get(orgKey);
    if (orgImg) document.getElementById("orgPreview").innerHTML = `<img src="${orgImg}">`;

    let globalIdx = 1;
    const groups = activeFactoryConfig[factory] || [];
    for (const group of groups) {
        const isKeyPersons = group.title === "Key Persons";
        for (const machineName of group.machines) {
            const idx = globalIdx++;
            const circlesNeeded = getCircleCount(factory, machineName);
            if (!isKeyPersons) {
                const machineImgKey = `MACHINE_BOX_${factory}_fileMachine-${idx}`;
                const img = await idbKeyval.get(machineImgKey);
                if(img && document.getElementById(`preview${idx}`)) {
                    document.getElementById(`preview${idx}`).innerHTML = `<img src="${img}">`;
                }
            }
            for(let c=1; c<=circlesNeeded; c++) {
                const circleId = `fileCircle-${idx}-${c}`;
                const circleKey = `CIRCLE_${factory}_${shift}_${circleId}`;
                const circImg = await idbKeyval.get(circleKey);
                if(circImg) document.getElementById(`circlePreview-${idx}-${c}`).innerHTML = `<img src="${circImg}">`;
            }
        }
    }

    const logs = await idbKeyval.get(getKey("logData")); 
    if(logs && Array.isArray(logs)) logs.forEach((log, index) => renderLogRow(log, index));
    
    buatDiagram();
    updateReportSummary(); 
}

function renderLogRow(log, index) {
    const tbody = document.getElementById("logTableBody");
    const row = tbody.insertRow();
    row.innerHTML = `<td>${log.tanggal}</td><td>${log.jenis}</td><td>${log.lokasi || "-"}</td><td>${log.deskripsi}</td><td>${log.cause || "-"}</td><td>${log.counter || "-"}</td><td>${log.pic}</td><td><button class="btn-delete" onclick="hapusLog(${index})">Ã—</button></td>`;
}

async function tambahLog(){
    const data = {
        tanggal: document.getElementById("tanggalHari").value,
        jenis: document.getElementById("logJenis").value,
        lokasi: document.getElementById("logLokasi").value, 
        deskripsi: document.getElementById("logDeskripsi").value,
        cause: document.getElementById("logCause").value,
        counter: document.getElementById("logCounter").value,
        pic: document.getElementById("logPIC").value
    };
    if(!data.jenis || !data.deskripsi) return alert("Lengkapi Jenis dan Deskripsi!");
    const key = getKey("logData");
    let list = await idbKeyval.get(key) || [];
    list.push(data);
    await idbKeyval.set(key, list);
    document.getElementById("logTableBody").innerHTML = "";
    list.forEach((log, index) => renderLogRow(log, index));
    ["logJenis", "logLokasi", "logDeskripsi", "logCause", "logCounter", "logPIC"].forEach(id => document.getElementById(id).value = "");
    updateReportSummary(); 
}

async function hapusLog(index) {
    const key = getKey("logData");
    let list = await idbKeyval.get(key);
    if(list && Array.isArray(list)) {
        list.splice(index, 1);
        await idbKeyval.set(key, list);
        document.getElementById("logTableBody").innerHTML = "";
        list.forEach((log, idx) => renderLogRow(log, idx));
        updateReportSummary(); 
    }
}

async function updateReportSummary() {
    const factory = document.getElementById("factorySelect").value;
    let totalMachines = 0;
    (activeFactoryConfig[factory] || []).forEach(g => totalMachines += g.machines.length);
    document.getElementById('totalMachines').innerText = totalMachines;
    const logs = await idbKeyval.get(getKey("logData")) || [];
    
    let manCount = 0; let machineCount = 0; let materialCount = 0; let methodCount = 0;
    const machineProblemsMap = {}; 
    logs.forEach(log => {
        if(log.jenis === 'Man') manCount++;
        if(log.jenis === 'Machine') machineCount++;
        if(log.jenis === 'Material') materialCount++;
        if(log.jenis === 'Method') methodCount++;
        if(log.lokasi) {
            if(!machineProblemsMap[log.lokasi]) { machineProblemsMap[log.lokasi] = []; }
            machineProblemsMap[log.lokasi].push(log.jenis);
        }
    });
    
    document.getElementById('manProblems').innerText = manCount;
    document.getElementById('machineProblems').innerText = machineCount;
    document.getElementById('materialProblems').innerText = materialCount;
    document.getElementById('methodProblems').innerText = methodCount;
    const problemMachinesCount = Object.keys(machineProblemsMap).length;
    const normalMachinesCount = totalMachines - problemMachinesCount;
    document.getElementById('problemMachines').innerText = problemMachinesCount;
    document.getElementById('normalMachines').innerText = normalMachinesCount;
    updateMachineVisuals(machineProblemsMap);
}

function updateMachineVisuals(problemsMap) {
    document.querySelectorAll('.status-lights-container').forEach(container => { container.innerHTML = ''; });
    for (const [machineName, problemsArray] of Object.entries(problemsMap)) {
        const safeName = machineName.replace(/"/g, '\\"');
        const box = document.querySelector(`.machine-box[data-name="${safeName}"]`);
        if (box) {
            const lightsContainer = box.querySelector('.status-lights-container');
            problemsArray.forEach(problemType => {
                const light = document.createElement('div');
                light.className = `status-light light-${problemType}`;
                light.title = problemType; 
                lightsContainer.appendChild(light);
            });
        }
    }
}

function showDetailedReport() { generateDetailedReport(); document.getElementById('reportModal').style.display = 'flex'; }
function closeModal() { document.getElementById('reportModal').style.display = 'none'; }

async function generateDetailedReport() {
    const factory = document.getElementById("factorySelect").value;
    const date = document.getElementById("tanggalHari").value;
    const shift = document.getElementById("shiftSelect").value;
    const tbody = document.getElementById('reportTableBody');
    tbody.innerHTML = '';
    const logs = await idbKeyval.get(getKey("logData")) || [];
    const logMap = {}; 
    logs.forEach(l => { if(!logMap[l.lokasi]) logMap[l.lokasi] = []; logMap[l.lokasi].push(l); });
    for (const group of (activeFactoryConfig[factory] || [])) {
        for (const machineName of group.machines) {
            const machineLogs = logMap[machineName];
            if (machineLogs && machineLogs.length > 0) {
                machineLogs.forEach(logEntry => {
                    const row = tbody.insertRow();
                    row.innerHTML = `<td>${date}</td><td>${shift}</td><td>${factory}</td><td>${machineName}</td><td style="font-weight:bold; color:red">PROBLEM</td><td>${logEntry.jenis}</td><td>${logEntry.deskripsi}</td><td>${logEntry.pic}</td>`;
                });
            } else {
                const row = tbody.insertRow();
                row.innerHTML = `<td>${date}</td><td>${shift}</td><td>${factory}</td><td>${machineName}</td><td style="font-weight:bold; color:green">NORMAL</td><td>-</td><td>Normal</td><td>-</td>`;
            }
        }
    }
}

// ==========================================================
// FUNGSI PROBLEM TREND
// ==========================================================
let trendChartInstance = null;
async function showProblemTrend() {
    const selectedDate = document.getElementById("tanggalHari").value;
    if (!selectedDate) return alert("Pilih tanggal terlebih dahulu.");
    const yearMonth = selectedDate.substring(0, 7); 
    const factory = document.getElementById("factorySelect").value;
    const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
    const monthLabel = monthNames[parseInt(selectedDate.substring(5, 7)) - 1] + " " + selectedDate.substring(0, 4);

    document.getElementById('trendModal').style.display = 'flex';
    document.getElementById('trendTitle').innerText = `ðŸ“ˆ Trend Problem ${factory} - ${monthLabel}`;

    const allKeys = await idbKeyval.keys();
    let monthlyLogs = [];
    const targetKeys = allKeys.filter(key => key.startsWith(yearMonth) && key.includes(factory) && key.endsWith("_logData"));

    for (const key of targetKeys) {
        const data = await idbKeyval.get(key);
        if (Array.isArray(data)) { monthlyLogs = monthlyLogs.concat(data); }
    }

    if (monthlyLogs.length === 0) {
        if (trendChartInstance) trendChartInstance.destroy();
    }

    const trendMap = {}; 
    monthlyLogs.forEach(log => {
        const day = log.tanggal.substring(8, 10);
        if (!trendMap[day]) trendMap[day] = { Man: 0, Material: 0, Machine: 0, Method: 0 };
        if (trendMap[day].hasOwnProperty(log.jenis)) { trendMap[day][log.jenis]++; }
    });

    const sortedDays = Object.keys(trendMap).sort();
    const dataMan = sortedDays.map(d => trendMap[d].Man);
    const dataMaterial = sortedDays.map(d => trendMap[d].Material);
    const dataMachine = sortedDays.map(d => trendMap[d].Machine);
    const dataMethod = sortedDays.map(d => trendMap[d].Method);

    const ctx = document.getElementById('trendChart').getContext('2d');
    if (trendChartInstance) trendChartInstance.destroy();

    trendChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: sortedDays,
            datasets: [
                { label: 'Man', data: dataMan, borderColor: '#e74c3c', backgroundColor: '#e74c3c', tension: 0.3 },
                { label: 'Material', data: dataMaterial, borderColor: '#f1c40f', backgroundColor: '#f1c40f', tension: 0.3 },
                { label: 'Machine', data: dataMachine, borderColor: '#3498db', backgroundColor: '#3498db', tension: 0.3 },
                { label: 'Method', data: dataMethod, borderColor: '#2ecc71', backgroundColor: '#2ecc71', tension: 0.3 }
            ]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom' }, datalabels: { display: false } },
            scales: { y: { beginAtZero: true, ticks: { stepSize: 1 }, title: { display: true, text: 'Jumlah Problem' } }, x: { title: { display: true, text: 'Tanggal' } } }
        }
    });
}
function closeTrendModal() { document.getElementById('trendModal').style.display = 'none'; }

// ==========================================================
// FUNGSI FACTORY UPDATES / EMPLOYEE CHANGE MODAL (DINAMIS & EDITABLE)
// ==========================================================
let tempFactoryConfig = null; 
let tempOperatorMapping = null;
let tempCircleCounts = null;
let editingRowIndex = null; // Format: "groupIndex-machineIndex"

function showEmployeeModal() {
    const factory = document.getElementById("factorySelect").value;
    // Deep copy current active config to temp
    tempFactoryConfig = JSON.parse(JSON.stringify(activeFactoryConfig));
    tempOperatorMapping = JSON.parse(JSON.stringify(activeOperatorMapping));
    tempCircleCounts = JSON.parse(JSON.stringify(activeCircleCounts));
    
    editingRowIndex = null; // Reset edit state
    renderModalTable();
    document.getElementById("employeeModal").style.display = "flex";
}

function renderModalTable() {
    const factory = document.getElementById("factorySelect").value;
    const shift = document.getElementById("shiftSelect").value;
    const tbody = document.getElementById("employeeTableBody");
    tbody.innerHTML = "";

    const groups = tempFactoryConfig[factory] || [];

    groups.forEach((group, groupIndex) => {
        // Header Group
        const groupRow = `
            <tr class="modal-group-row">
                <td colspan="4" class="modal-group-header"><span>${group.title}</span></td>
                <td class="modal-group-header" style="text-align: center;">
                    <button class="btn-add-section" onclick="addMachineToGroup(${groupIndex})">+</button>
                </td>
            </tr>
        `;
        tbody.innerHTML += groupRow;

        group.machines.forEach((machine, machineIndex) => {
            const isEditing = editingRowIndex === `${groupIndex}-${machineIndex}`;
            
            // Get Current Values from TEMP
            // 1. Total MP
            let total = 2; // Default
            if (tempCircleCounts[factory] && tempCircleCounts[factory][machine]) {
                total = tempCircleCounts[factory][machine];
            } else {
                total = getCircleCount(factory, machine); // Fallback to logic
            }

            // 2. Names
            let names = [];
            if (tempOperatorMapping[factory] && tempOperatorMapping[factory][machine] && tempOperatorMapping[factory][machine][shift]) {
                names = tempOperatorMapping[factory][machine][shift];
            }
            let nameString = names.join(", ");

            if (isEditing) {
                // RENDER INPUT FIELDS - MODIFIED WITH AUTOFOCUS
                const row = `<tr>
                    <td><input type="text" class="input-edit" id="editName-${groupIndex}-${machineIndex}" value="${machine}" placeholder="Ketik Nama Mesin..." autofocus></td>
                    <td style="text-align:center"><input type="number" class="input-edit" id="editTotal-${groupIndex}-${machineIndex}" value="${total}" style="width:50px; text-align:center"></td>
                    <td><input type="text" class="input-edit" id="editEmp-${groupIndex}-${machineIndex}" value="${nameString}" placeholder="Nama Karyawan (koma)"></td>
                    <td style="text-align:center">
                        <button class="btn-save-row" onclick="saveRowEdit(${groupIndex}, ${machineIndex})">Save</button>
                    </td>
                    <td style="text-align:center">
                        <button class="btn-delete-row" onclick="deleteMachineRow(${groupIndex}, ${machineIndex})">Ã—</button>
                    </td>
                </tr>`;
                tbody.innerHTML += row;
            } else {
                // RENDER TEXT ONLY
                const row = `<tr>
                    <td>${machine}</td>
                    <td style="text-align:center">${total}</td>
                    <td>${nameString}</td>
                    <td style="text-align:center">
                        <button class="btn-edit-row" onclick="toggleEditRow(${groupIndex}, ${machineIndex})">Edit</button>
                    </td>
                    <td style="text-align:center">
                        <button class="btn-delete-row" onclick="deleteMachineRow(${groupIndex}, ${machineIndex})">Ã—</button>
                    </td>
                </tr>`;
                tbody.innerHTML += row;
            }
        });
    });
}

function toggleEditRow(groupIndex, machineIndex) {
    editingRowIndex = `${groupIndex}-${machineIndex}`;
    renderModalTable();
}

function saveRowEdit(groupIndex, machineIndex) {
    const factory = document.getElementById("factorySelect").value;
    const shift = document.getElementById("shiftSelect").value;

    const oldMachineName = tempFactoryConfig[factory][groupIndex].machines[machineIndex];
    const newMachineName = document.getElementById(`editName-${groupIndex}-${machineIndex}`).value.trim();
    const newTotal = parseInt(document.getElementById(`editTotal-${groupIndex}-${machineIndex}`).value) || 0;
    const newEmpString = document.getElementById(`editEmp-${groupIndex}-${machineIndex}`).value;
    
    // Split string back to array, trim whitespace
    const newEmpArray = newEmpString.split(',').map(s => s.trim()).filter(s => s !== "");

    if (!newMachineName) return alert("Nama mesin tidak boleh kosong!");

    // UPDATE CONFIG (Name)
    tempFactoryConfig[factory][groupIndex].machines[machineIndex] = newMachineName;

    // UPDATE CIRCLE COUNTS (Total)
    if (!tempCircleCounts[factory]) tempCircleCounts[factory] = {};
    // Hapus key lama jika nama berubah
    if (oldMachineName !== newMachineName && tempCircleCounts[factory][oldMachineName]) {
        delete tempCircleCounts[factory][oldMachineName];
    }
    tempCircleCounts[factory][newMachineName] = newTotal;

    // UPDATE OPERATOR MAPPING (Names)
    if (!tempOperatorMapping[factory]) tempOperatorMapping[factory] = {};
    // Handle rename di mapping
    if (oldMachineName !== newMachineName) {
        if (tempOperatorMapping[factory][oldMachineName]) {
             // Pindahkan data shift lain jika ada
             tempOperatorMapping[factory][newMachineName] = tempOperatorMapping[factory][oldMachineName];
             delete tempOperatorMapping[factory][oldMachineName];
        }
    }
    // Set data baru untuk shift ini
    if (!tempOperatorMapping[factory][newMachineName]) tempOperatorMapping[factory][newMachineName] = {};
    tempOperatorMapping[factory][newMachineName][shift] = newEmpArray;

    editingRowIndex = null; // Keluar mode edit
    renderModalTable();
}

// FUNGSI INI TELAH DIPERBAIKI (TIDAK LAGI MEMAKAI PROMPT)
function addMachineToGroup(groupIndex) {
    const factory = document.getElementById("factorySelect").value;
    
    // 1. Tambahkan string kosong sebagai placeholder
    tempFactoryConfig[factory][groupIndex].machines.push("");
    
    // 2. Tentukan index elemen baru (paling terakhir)
    const newIndex = tempFactoryConfig[factory][groupIndex].machines.length - 1;
    
    // 3. Set mode edit ke baris baru tersebut
    editingRowIndex = `${groupIndex}-${newIndex}`;
    
    // 4. Render ulang tabel
    renderModalTable();
}

function deleteMachineRow(groupIndex, machineIndex) {
    const factory = document.getElementById("factorySelect").value;
    if (confirm("Apakah anda yakin ingin menghapus mesin ini?")) {
        tempFactoryConfig[factory][groupIndex].machines.splice(machineIndex, 1);
        renderModalTable();
    }
}

async function saveEmployeeChanges() {
    // Commit temp to active
    activeFactoryConfig = JSON.parse(JSON.stringify(tempFactoryConfig));
    activeOperatorMapping = JSON.parse(JSON.stringify(tempOperatorMapping));
    activeCircleCounts = JSON.parse(JSON.stringify(tempCircleCounts));

    // Persist to DB
    await idbKeyval.set("FACTORY_CONFIG", activeFactoryConfig);
    await idbKeyval.set("OPERATOR_MAPPING", activeOperatorMapping);
    await idbKeyval.set("CIRCLE_COUNTS", activeCircleCounts);
    
    // Refresh Main View
    loadAllData();
    
    closeEmployeeModal();
}

function closeEmployeeModal() {
    document.getElementById("employeeModal").style.display = "none";
    tempFactoryConfig = null;
    tempOperatorMapping = null;
    tempCircleCounts = null;
    editingRowIndex = null;
}

Chart.register(ChartDataLabels);
let chart;
function buatDiagram(){
    const data=[
        +document.getElementById("mpHadir").value||0, +document.getElementById("mpBelum").value||0, 
        +document.getElementById("pCuti").value||0, +document.getElementById("pSakit").value||0,  
        +document.getElementById("pIjin").value||0, +document.getElementById("oCuti").value||0,   
        +document.getElementById("oSakit").value||0, +document.getElementById("oIjin").value||0    
    ];
    const total=data.reduce((a,b)=>a+b,0);
    const centerValue = document.getElementById("centerValue");
    const rasioText = document.getElementById("rasioText");
    if(total===0) {
        centerValue.innerText="0 / 0"; rasioText.style.width="0%"; rasioText.innerText="Attendance: 0%";
        if(chart) chart.destroy(); return;
    }
    const hadir=data[0];
    const persen=((hadir/total)*100).toFixed(1);
    centerValue.innerText=hadir+" / "+total;
    rasioText.style.width=persen+"%";
    rasioText.innerText="Attendance: "+persen+"%";
    if(chart) chart.destroy();
    chart=new Chart(document.getElementById("myChart"),{
        type:"doughnut",
        data:{datasets:[{data:data,backgroundColor:["#2ecc71", "#e74c3c", "#1f3c88", "#5dade2","#f39c12", "#ff69b4", "#8e44ad", "#f1c40f"],borderWidth: 0}]},
        options:{cutout:"75%",responsive: true,maintainAspectRatio: false,plugins:{legend:{display:false},datalabels:{display:false}}}
    });
}

// ==========================================================
// FUNGSI EXPORT EXCEL
// ==========================================================
async function exportExcel() {
    const selectedDate = document.getElementById("tanggalHari").value;
    if (!selectedDate) return alert("Harap pilih tanggal terlebih dahulu.");
    
    const factory = document.getElementById("factorySelect").value;
    const targetMonth = selectedDate.substring(0, 7); 
    const monthLabel = new Date(selectedDate).toLocaleString('id-ID', { month: 'long', year: 'numeric' });

    const allEntries = await idbKeyval.entries();
    const monthlyEntries = allEntries.filter(([key, val]) => 
        key.startsWith(targetMonth) && key.includes(factory)
    );

    if (monthlyEntries.length === 0) {
        return alert(`Tidak ada data ditemukan untuk ${factory} pada bulan ${monthLabel}.`);
    }

    const attendanceMap = {}; 
    let allLogs = [];
    
    monthlyEntries.forEach(([key, val]) => {
        const firstUnderscore = key.indexOf('_');
        const dateStr = key.substring(0, firstUnderscore);
        const remainder = key.substring(firstUnderscore + 1);
        const shiftMatch = remainder.match(/(.*)_(Shift [AB])_(.*)/);
        
        if (shiftMatch && shiftMatch[2]) {
            const shift = shiftMatch[2];
            const variableName = shiftMatch[3];

            if (variableName === 'logData') {
                if (Array.isArray(val)) {
                    val.forEach(logItem => {
                        allLogs.push({
                            Date: dateStr,
                            Shift: shift,
                            ...logItem
                        });
                    });
                }
            } else {
                const rowKey = `${dateStr}_${shift}`;
                if (!attendanceMap[rowKey]) {
                    attendanceMap[rowKey] = { Date: dateStr, Shift: shift };
                }
                attendanceMap[rowKey][variableName] = val;
            }
        }
    });

    let manCount = 0, machineCount = 0, materialCount = 0, methodCount = 0;
    allLogs.forEach(l => {
        if(l.jenis === 'Man') manCount++;
        if(l.jenis === 'Machine') machineCount++;
        if(l.jenis === 'Material') materialCount++;
        if(l.jenis === 'Method') methodCount++;
    });

    const summaryData = [
        { "Metric": "Factory", "Value": factory },
        { "Metric": "Bulan", "Value": monthLabel },
        { "Metric": "Total Logs", "Value": allLogs.length },
        { "Metric": "Man Problems", "Value": manCount },
        { "Metric": "Machine Problems", "Value": machineCount },
        { "Metric": "Material Problems", "Value": materialCount },
        { "Metric": "Method Problems", "Value": methodCount },
        { "Metric": "Export Time", "Value": new Date().toLocaleString() }
    ];

    const attendanceData = Object.values(attendanceMap).sort((a, b) => {
        if (a.Date !== b.Date) return a.Date.localeCompare(b.Date);
        return a.Shift.localeCompare(b.Shift);
    }).map(item => ({
        Tanggal: item.Date,
        Shift: item.Shift,
        "MP Hadir": item.mpHadir || 0,
        "MP Belum Absen": item.mpBelum || 0,
        "Pengawas Cuti": item.pCuti || 0,
        "Pengawas Sakit": item.pSakit || 0,
        "Pengawas Izin": item.pIjin || 0,
        "Operator Cuti": item.oCuti || 0,
        "Operator Sakit": item.oSakit || 0,
        "Operator Ijin": item.oIjin || 0
    }));

    const detailedLogsData = allLogs.sort((a,b) => a.Date.localeCompare(b.Date)).map(log => ({
        Tanggal: log.Date,
        Shift: log.Shift,
        Factory: factory,
        Lokasi: log.lokasi,
        "Jenis Problem": log.jenis,
        Deskripsi: log.deskripsi,
        Cause: log.cause,
        Countermeasure: log.counter,
        PIC: log.pic
    }));

    const trendMap = {};
    allLogs.forEach(log => {
        if (!trendMap[log.Date]) trendMap[log.Date] = { Tanggal: log.Date, Man: 0, Machine: 0, Material: 0, Method: 0, Total: 0 };
        if (["Man", "Machine", "Material", "Method"].includes(log.jenis)) {
            trendMap[log.Date][log.jenis]++;
            trendMap[log.Date].Total++;
        }
    });
    const trendData = Object.values(trendMap).sort((a,b) => a.Tanggal.localeCompare(b.Tanggal));

    const wb = XLSX.utils.book_new();
    const wsSummary = XLSX.utils.json_to_sheet(summaryData);
    XLSX.utils.book_append_sheet(wb, wsSummary, "Summary");
    const wsAttendance = XLSX.utils.json_to_sheet(attendanceData);
    XLSX.utils.book_append_sheet(wb, wsAttendance, "Kehadiran");
    const wsLogs = XLSX.utils.json_to_sheet(detailedLogsData);
    XLSX.utils.book_append_sheet(wb, wsLogs, "Detailed Logs");
    const wsTrend = XLSX.utils.json_to_sheet(trendData);
    XLSX.utils.book_append_sheet(wb, wsTrend, "Problem Trend");

    const fileName = `Henkaten_Report_${factory}_${targetMonth}.xlsx`;
    XLSX.writeFile(wb, fileName);
}

// ==========================================================
// 6. FUNGSI AUTOSCROLL
// ==========================================================
function startAutoScroll() {
    const container = document.querySelector('.right-scroll-area');
    if (!container) return;
    let scrollSpeed = 0.3; let direction = 1; let isPaused = false;
    let currentScrollPos = container.scrollTop; 
    container.addEventListener('mouseenter', () => { isPaused = true; });
    container.addEventListener('mouseleave', () => { isPaused = false; currentScrollPos = container.scrollTop; });
    container.addEventListener('touchstart', () => { isPaused = true; });
    container.addEventListener('touchend', () => { isPaused = false; });
    function step() {
        if (!isPaused) {
            const maxScroll = container.scrollHeight - container.clientHeight;
            if (maxScroll > 0) {
                currentScrollPos += (scrollSpeed * direction);
                container.scrollTop = currentScrollPos;
                if (direction === 1) { if (currentScrollPos >= maxScroll) { currentScrollPos = maxScroll; direction = -1; } } 
                else { if (currentScrollPos <= 0) { currentScrollPos = 0; direction = 1; } }
            } else { currentScrollPos = 0; }
        } else { currentScrollPos = container.scrollTop; }
        requestAnimationFrame(step);
    }
    requestAnimationFrame(step);
}
window.addEventListener('DOMContentLoaded', () => { loadAllData(); startAutoScroll(); });
</script>
</body>
</html>